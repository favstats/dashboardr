---
title: "Advanced Features"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Advanced Features}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width = 7,
  fig.height = 5
)
```

```{r setup, message=FALSE, warning=FALSE}
library(dashboardr)
library(dplyr)

# Load GSS data for examples
library(gssr)
# Load latest wave only
data(gss_all)
gss <- gss_all %>%
  select(year, age, sex, race, degree, happy, polviews, wtssall) %>%
  filter(year == max(year, na.rm = TRUE), !is.na(age), !is.na(sex), !is.na(race), !is.na(degree))
```

## Multiple Visualizations at Once

### add_vizzes()

Create multiple similar visualizations in one call:

```{r}
questions <- c("degree", "race", "happy")
labels <- c("Education", "Race", "Happiness")

viz <- create_content(data = gss, type = "bar") %>%
  add_vizzes(x_var = questions, title = labels, tabgroup = "survey")

print(viz)
```

```{r}
viz %>% preview()
```

### Likert-Scale Surveys

Use `type = "stackedbars"` within `create_content()`:

```{r, eval=FALSE}
create_content(data = survey_data, type = "stackedbars") %>%
  add_viz(
    x_vars = c("q1", "q2", "q3", "q4"),
    x_var_labels = c("I enjoy my work",
                     "I feel valued",
                     "I have growth opportunities",
                     "I would recommend"),
    title = "Employee Sentiment",
    stacked_type = "percent",
    horizontal = TRUE
  ) %>%
  preview()
```

## Weighted Visualizations

Apply survey weights:

```{r}
weighted <- create_content(data = gss, type = "bar", weight_var = "wtssall") %>%
  add_viz(x_var = "degree", title = "Weighted Education")

print(weighted)
```

```{r}
weighted %>% preview()
```

## Filtering

### Basic Filters

```{r}
filtered <- create_content(data = gss, type = "bar") %>%
  add_viz(x_var = "happy", title = "Happiness", filter = ~ sex == 1,
          title_tabset = "Male", tabgroup = "analysis") %>%
  add_viz(x_var = "happy", title = "Happiness", filter = ~ sex == 2,
          title_tabset = "Female", tabgroup = "analysis")

print(filtered)
```

```{r}
filtered %>% preview()
```

### Complex Filters

```{r, eval=FALSE}
add_viz(
  x_var = "happy",
  filter = ~ year >= 2015 & degree %in% c(2, 3, 4)
)
```

## Timeline Charts

Track changes over time:

```{r, eval=FALSE}
create_content(type = "timeline") %>%
  add_viz(
    time_var = "year",
    response_var = "happy",
    title = "Happiness Over Time",
    chart_type = "line",
    group_var = "sex"
  )
```

## Heatmaps

Visualize intensity across two dimensions:

```{r, eval=FALSE}
create_content(type = "heatmap") %>%
  add_viz(
    x_var = "degree",
    y_var = "happy",
    value_var = "count",
    title = "Happiness by Education",
    agg_fun = "count",
    x_order_by = "desc",  # Order by values
    y_order_by = "desc"
  )
```

## Icons

dashboardr uses [Iconify](https://icon-sets.iconify.design/) for **200,000+ icons** from 100+ icon sets!

### Format

```r
icon = "ph:house-fill"  # icon-set:icon-name
```

### Popular Icon Sets

| Set | Prefix | Examples |
|-----|--------|----------|
| Phosphor | `ph:` | `ph:chart-line`, `ph:users-fill`, `ph:gear-fill` |
| Bootstrap | `bi:` | `bi:graph-up`, `bi:people`, `bi:gear` |
| Font Awesome | `fa:` | `fa:chart-bar`, `fa:users` |
| Material Design | `mdi:` | `mdi:chart-line`, `mdi:account-group` |

### Page Icons

```{r, eval=FALSE}
create_page(
  "Home",
  icon = "ph:house-fill"
)

create_page(
  "Analysis",
  icon = "ph:chart-bar-fill"
)
```

### Tab Group Icons

```{r, eval=FALSE}
viz <- create_content(type = "bar") %>%
  add_viz(x_var = "age", tabgroup = "demographics") %>%
  add_viz(x_var = "income", tabgroup = "financial") %>%
  set_tabgroup_labels(
    demographics = "{{< iconify ph:users-fill >}} Demographics",
    financial = "{{< iconify ph:currency-dollar >}} Financial"
  )
```

### In Markdown Text

```{r, eval=FALSE}
add_text(
  "## Features {{< iconify ph:sparkle-fill >}}",
  "",
  "- {{< iconify ph:check-circle-fill >}} Easy to use",
  "- {{< iconify ph:lightning-fill >}} Fast performance",
  "- {{< iconify ph:heart-fill >}} Beautiful design"
)
```

### Finding Icons

Visit [Iconify Icon Sets](https://icon-sets.iconify.design/) to browse and search.

**Common choices:**

| Purpose | Icons |
|---------|-------|
| Home | `ph:house-fill`, `bi:house-fill`, `mdi:home` |
| Charts | `ph:chart-line`, `ph:chart-bar-fill`, `bi:graph-up` |
| Users | `ph:users-fill`, `bi:people-fill`, `mdi:account-group` |
| Settings | `ph:gear-fill`, `bi:gear-fill`, `mdi:cog` |
| Info | `ph:info-fill`, `bi:info-circle-fill`, `mdi:information` |

### Best Practice: Consistency

Pick one icon set and stick with it:

```{r, eval=FALSE}
# Good: All Phosphor icons
create_page("Home", icon = "ph:house-fill")
create_page("Analysis", icon = "ph:chart-line")
create_page("About", icon = "ph:info-fill")

# Avoid: Mixed icon sets
create_page("Home", icon = "ph:house-fill")
create_page("Analysis", icon = "bi:graph-up")     # Different set
create_page("About", icon = "mdi:information")    # Another set
```

## Loading Overlays

Add loading animations for heavy content:

```{r, eval=FALSE}
create_page(
  "Analysis",
  data = large_dataset,
  overlay = TRUE,
  overlay_theme = "glass",  # "light", "dark", "accent"
  overlay_text = "Loading analysis...",
  overlay_duration = 1500   # milliseconds
)
```

## Lazy Loading

Load content on-demand for better performance:

```{r, eval=FALSE}
create_page(
  "Reports",
  data = data,
  lazy_load_charts = TRUE,     # Load charts as user scrolls
  lazy_load_margin = "300px",  # Start loading 300px before visible
  lazy_load_tabs = TRUE        # Load tab content when clicked
)
```

## Rich Text Content

### md_text()

```{r, eval=FALSE}
text = md_text(
  "# Main Heading",
  "",
  "Paragraph with **bold** and *italic*.",
  "",
  "- Bullet 1",
  "- Bullet 2"
)
```

### Embedded R Code

```{r, eval=FALSE}
add_text(
  "## Survey Overview",
  "",
  "```{r, echo=FALSE}",
  "create_blockquote(",
  "  'This survey was conducted in Q1 2025.',",
  "  preset = 'info'",
  ")",
  "```"
)
```

### Card Layouts

```{r, eval=FALSE}
add_text(
  "```{r, echo=FALSE}",
  "person_card <- card(",
  "  title = 'Dr. Jane Smith',",
  "  content = 'Lead data scientist.',",
  "  image = 'https://example.com/jane.jpg'",
  ")",
  "card_row(person_card)",
  "```"
)
```

### Blockquotes

Presets: `'default'`, `'info'`, `'success'`, `'warning'`, `'danger'`, `'question'`

```{r, eval=FALSE}
add_text(
  "```{r, echo=FALSE}",
  "create_blockquote(",
  "  'All data has been anonymized.',",
  "  preset = 'warning'",
  ")",
  "```"
)
```

## Navbar Customization

### Dropdown Menus

```{r, eval=FALSE}
create_dashboard(
  title = "My Dashboard",
  output_dir = "output",
  navbar_left = list(
    list(
      text = "Analysis",
      menu = list(
        list(text = "Demographics", href = "demographics.html"),
        list(text = "Trends", href = "trends.html"),
        list(text = "---"),  # Divider
        list(text = "Download", href = "data.csv")
      )
    )
  )
)
```

### Sidebar Navigation

```{r, eval=FALSE}
create_dashboard(
  title = "My Dashboard",
  output_dir = "output",
  sidebar = TRUE,
  sidebar_title = "Navigation",
  sidebar_style = "floating"  # "docked" or "floating"
)
```

## Pagination

Break long dashboards into sections:

```{r}
section1 <- create_content(type = "bar") %>%
  add_viz(x_var = "degree", title = "Education", tabgroup = "demographics")

section2 <- create_content(type = "stackedbar") %>%
  add_viz(x_var = "happy", stack_var = "sex", title = "Happiness", tabgroup = "crosstabs")

paginated <- section1 %>%
  add_pagination() %>%
  combine_viz(section2)

print(paginated)
```

## Tips and Best Practices

### 1. Always Print During Development

```{r, eval=FALSE}
# See visualization structure
print(my_viz)

# See page structure
print(my_page)

# See dashboard pages
print(dashboard)
```

### 2. Set Sensible Defaults

```{r, eval=FALSE}
# Good: Set common parameters once
viz <- create_content(
  type = "bar",
  color_palette = c("#3498DB"),
  drop_na_vars = TRUE
)

# Avoid: Repeating parameters
viz <- create_content(type = "bar") %>%
  add_viz(x_var = "age", color_palette = c("#3498DB")) %>%
  add_viz(x_var = "income", color_palette = c("#3498DB"))
```

### 3. Organize Large Dashboards

```{r, eval=FALSE}
# Create modular content collections
demographics <- create_content(...) %>% add_viz(...)
satisfaction <- create_content(...) %>% add_viz(...)
trends <- create_content(...) %>% add_viz(...)

# Combine them
all_content <- demographics %>%
  combine_viz(satisfaction) %>%
  add_pagination() %>%
  combine_viz(trends)
```

### 4. Use Lazy Loading for Performance

```{r, eval=FALSE}
create_page(
  "Large Analysis",
  data = data,
  lazy_load_charts = TRUE,
  lazy_load_tabs = TRUE
)
```

### 5. Test Without Rendering

```{r, eval=FALSE}
# Fast iteration: just create QMD files
generate_dashboard(dashboard, render = FALSE)

# Check structure, fix issues, then render
generate_dashboard(dashboard, render = TRUE)
```

## Debugging

### Common Issues

**Visualization not showing:**

```{r, eval=FALSE}
# Check variable names match your data
names(my_data)

# Check for NA values
summary(my_data$x_var)

# Use drop_na_vars if needed
add_viz(x_var = "age", drop_na_vars = TRUE)
```

**Filter not working:**

```{r, eval=FALSE}
# Correct: use formula with ~
add_viz(x_var = "age", filter = ~ wave == 1)

# Wrong: missing ~
add_viz(x_var = "age", filter = wave == 1)
```

**Tabs in wrong order:**

Tabs appear in the order of `add_viz()` calls. Reorder your code to change tab order:

```{r, eval=FALSE}
# Check the structure
print(viz)

# Reorder by changing add_viz() order
viz <- create_content(...) %>%
  add_viz(..., tabgroup = "first") %>%   # Will appear first
  add_viz(..., tabgroup = "second") %>%  # Will appear second
  add_viz(..., tabgroup = "third")       # Will appear third
```

### Getting Help

```{r, eval=FALSE}
# Function documentation
?create_dashboard
?add_viz
?generate_dashboard

# Package overview
help(package = "dashboardr")

# All vignettes
vignette(package = "dashboardr")
```

## Advanced Features Gallery

This gallery demonstrates all advanced features with both `print()` (structure) and `preview()` (rendered) output.

### Weighted Data Visualizations

Apply survey weights to get population-representative results.

```{r}
weighted_demo <- create_content(data = gss, type = "bar") %>%
  add_viz(x_var = "degree", title = "Unweighted", tabgroup = "Comparison") %>%
  add_viz(x_var = "degree", title = "Weighted", weight_var = "wtssall", tabgroup = "Comparison")

print(weighted_demo)
```

```{r}
weighted_demo %>% preview()
```

### Multi-Filter Comparisons

Compare the same variable across different subgroups.

```{r}
age_groups <- create_content(data = gss, type = "bar") %>%
  add_viz(x_var = "happy", title = "Young Adults (18-35)", 
          filter = ~ age >= 18 & age <= 35, tabgroup = "Age") %>%
  add_viz(x_var = "happy", title = "Middle Age (36-55)", 
          filter = ~ age > 35 & age <= 55, tabgroup = "Age") %>%
  add_viz(x_var = "happy", title = "Older Adults (55+)", 
          filter = ~ age > 55, tabgroup = "Age")

print(age_groups)
```

```{r}
age_groups %>% preview()
```

### title_tabset for Sub-Tabs

Create automatic sub-tabs within a tabgroup using `title_tabset`.

```{r}
gender_tabs <- create_content(data = gss, type = "bar") %>%
  add_viz(x_var = "happy", title = "Happiness", 
          filter = ~ sex == 1, title_tabset = "Male", tabgroup = "Happiness") %>%
  add_viz(x_var = "happy", title = "Happiness", 
          filter = ~ sex == 2, title_tabset = "Female", tabgroup = "Happiness") %>%
  add_viz(x_var = "degree", title = "Education", 
          filter = ~ sex == 1, title_tabset = "Male", tabgroup = "Education") %>%
  add_viz(x_var = "degree", title = "Education", 
          filter = ~ sex == 2, title_tabset = "Female", tabgroup = "Education")

print(gender_tabs)
```

```{r}
gender_tabs %>% preview()
```

### Nested Tabgroups

Create hierarchical tab structures with `/` separator.

```{r}
nested <- create_content(data = gss, type = "bar") %>%
  add_viz(x_var = "degree", title = "Education", 
          tabgroup = "Demographics/Background") %>%
  add_viz(x_var = "race", title = "Race", 
          tabgroup = "Demographics/Background") %>%
  add_viz(x_var = "age", title = "Age", 
          tabgroup = "Demographics/Age Info") %>%
  add_viz(x_var = "happy", title = "Happiness", 
          tabgroup = "Attitudes/Wellbeing") %>%
  add_viz(x_var = "polviews", title = "Politics", 
          tabgroup = "Attitudes/Political")

print(nested)
```

```{r}
nested %>% preview()
```

### Batch Creation with add_vizzes()

Create multiple visualizations efficiently.

```{r}
vars <- c("degree", "race", "happy", "polviews")
titles <- c("Education Level", "Race/Ethnicity", "Happiness", "Political Views")

batch <- create_content(data = gss, type = "bar") %>%
  add_vizzes(x_var = vars, title = titles, tabgroup = "Survey Variables")

print(batch)
```

```{r}
batch %>% preview()
```

### Custom Tabgroup Labels

Replace tabgroup IDs with human-readable labels.

```{r}
labeled <- create_content(data = gss, type = "bar") %>%
  add_viz(x_var = "degree", title = "Education", tabgroup = "demo") %>%
  add_viz(x_var = "happy", title = "Happiness", tabgroup = "att") %>%
  set_tabgroup_labels(
    demo = "Demographics",
    att = "Attitudes & Values"
  )

print(labeled)
```

```{r}
labeled %>% preview()
```

### Combining Multiple Collections

Merge separate content collections while preserving structure.

```{r}
# Build sections separately
demographics <- create_content(data = gss, type = "bar") %>%
  add_viz(x_var = "degree", title = "Education", tabgroup = "Demographics")

attitudes <- create_content(data = gss, type = "bar") %>%
  add_viz(x_var = "happy", title = "Happiness", tabgroup = "Attitudes")

crosstabs <- create_content(data = gss, type = "stackedbar") %>%
  add_viz(x_var = "degree", stack_var = "happy", 
          title = "Happiness by Education", tabgroup = "Analysis",
          stacked_type = "percent")

# Combine with + operator
combined <- demographics + attitudes + crosstabs

print(combined)
```

```{r}
combined %>% preview()
```

### Pagination Between Sections

Insert page breaks for long content.

```{r}
paginated <- demographics %>%
  add_pagination() %>%
  combine_viz(attitudes) %>%
  add_pagination() %>%
  combine_viz(crosstabs)

print(paginated)
```

### Mixed Content with Visualizations

Combine explanatory text with charts.

```{r}
mixed <- create_content(data = gss, type = "bar") %>%
  add_text(
    "## Survey Analysis",
    "",
    "This section presents key findings from the GSS data."
  ) %>%
  add_callout("Sample size: 21,788 respondents (2010-2024)", type = "note") %>%
  add_viz(x_var = "degree", title = "Education Distribution") %>%
  add_divider() %>%
  add_text("### Interpretation", "", "The data shows variation across education levels.") %>%
  add_accordion(
    title = "Technical Notes",
    text = "Weighted data using wtssall variable. Missing values excluded."
  )

print(mixed)
```

```{r}
mixed %>% preview()
```

### Dashboard-Style Metrics

KPIs and value boxes for executive summaries.

```{r}
dashboard_style <- create_content(data = gss, type = "bar") %>%
  add_text("## Key Metrics") %>%
  add_value_box_row() %>%
    add_value_box(title = "Respondents", value = "21,788", bg_color = "#3498DB") %>%
    add_value_box(title = "Years", value = "15", bg_color = "#27AE60") %>%
    add_value_box(title = "Response Rate", value = "68%", bg_color = "#9B59B6") %>%
  end_value_box_row() %>%
  add_spacer(height = "2rem") %>%
  add_viz(x_var = "degree", title = "Primary Distribution")

print(dashboard_style)
```

```{r}
dashboard_style %>% preview()
```

### Rich Text Formatting

Cards, quotes, and badges for polished reports.

```{r}
rich_text <- create_content() %>%
  add_text("## Executive Summary") %>%
  add_card(
    title = "Key Finding",
    text = "Education shows the strongest correlation with life satisfaction across all age groups."
  ) %>%
  add_quote(
    quote = "Education is the passport to the future, for tomorrow belongs to those who prepare for it today.",
    attribution = "Malcolm X"
  ) %>%
  add_text("### Status Indicators") %>%
  add_badge("Phase 1", color = "success") %>%
  add_badge("Phase 2", color = "warning") %>%
  add_badge("Phase 3", color = "secondary")

print(rich_text)
```

```{r}
rich_text %>% preview()
```

### Complete Research Report Pattern

Full research report layout.

```{r}
research_report <- create_content(data = gss, type = "bar") %>%
  add_text(
    "## Research Report",
    "",
    "### Background",
    "",
    "This study examines the relationship between education and subjective well-being."
  ) %>%
  add_accordion(
    title = "Methodology",
    text = "Cross-sectional analysis using GSS data (2010-2024). N=21,788."
  ) %>%
  add_callout("Hypothesis: Higher education is associated with greater happiness.", type = "note") %>%
  add_divider() %>%
  add_text("### Results") %>%
  add_viz(x_var = "degree", stack_var = "happy", 
          title = "Happiness by Education Level",
          stacked_type = "percent") %>%
  add_divider() %>%
  add_text(
    "### Discussion",
    "",
    "The results support the hypothesis, with college graduates showing higher happiness."
  ) %>%
  add_callout(
    "Limitation: Correlation does not imply causation. Selection effects may be present.",
    type = "warning"
  )

print(research_report)
```

```{r}
research_report %>% preview()
```

## Related Vignettes

- `vignette("getting-started")` - Quick overview
- `vignette("content-collections")` - Layer 1: Content
- `vignette("pages")` - Layer 2: Pages
- `vignette("dashboards")` - Layer 3: Dashboard
